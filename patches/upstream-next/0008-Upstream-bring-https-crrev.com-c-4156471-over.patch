From 7d347e9c19c224fa36104978e9869337df7e30ec Mon Sep 17 00:00:00 2001
From: Dan Stahr <danstahr@google.com>
Date: Wed, 11 Jan 2023 16:06:48 +0000
Subject: [PATCH] Upstream: bring https://crrev.com/c/4156471 over

Test: m
Change-Id: Iae1059c6b923afef48c682885512966c8669dfa9
---
 Android.bp                                    |  7 +++++
 base/BUILD.gn                                 |  1 +
 .../java/src/org/chromium/base/PiiElider.java | 13 ++++++++--
 base/android/jni_android.cc                   | 26 +++----------------
 4 files changed, 23 insertions(+), 24 deletions(-)

diff --git a/Android.bp b/Android.bp
index 639d110d..9046dd0d 100644
--- a/Android.bp
+++ b/Android.bp
@@ -1092,6 +1092,7 @@ cc_genrule {
         "base/android/java/src/org/chromium/base/MemoryPressureListener.java",
         "base/android/java/src/org/chromium/base/PathService.java",
         "base/android/java/src/org/chromium/base/PathUtils.java",
+        "base/android/java/src/org/chromium/base/PiiElider.java",
         "base/android/java/src/org/chromium/base/PowerMonitor.java",
         "base/android/java/src/org/chromium/base/RadioUtils.java",
         "base/android/java/src/org/chromium/base/SysUtils.java",
@@ -1165,6 +1166,8 @@ cc_genrule {
          "--output_name " +
          "PathUtils_jni.h " +
          "--output_name " +
+         "PiiElider_jni.h " +
+         "--output_name " +
          "PowerMonitor_jni.h " +
          "--output_name " +
          "RadioUtils_jni.h " +
@@ -1245,6 +1248,8 @@ cc_genrule {
          "--input_file " +
          "$(location base/android/java/src/org/chromium/base/PathUtils.java) " +
          "--input_file " +
+         "$(location base/android/java/src/org/chromium/base/PiiElider.java) " +
+         "--input_file " +
          "$(location base/android/java/src/org/chromium/base/PowerMonitor.java) " +
          "--input_file " +
          "$(location base/android/java/src/org/chromium/base/RadioUtils.java) " +
@@ -1309,6 +1314,7 @@ cc_genrule {
         "base/base_jni_headers/NativeUmaRecorder_jni.h",
         "base/base_jni_headers/PathService_jni.h",
         "base/base_jni_headers/PathUtils_jni.h",
+        "base/base_jni_headers/PiiElider_jni.h",
         "base/base_jni_headers/PostTask_jni.h",
         "base/base_jni_headers/PowerMonitor_jni.h",
         "base/base_jni_headers/RadioUtils_jni.h",
@@ -4295,6 +4301,7 @@ java_library {
         "-Aorg.chromium.chrome.skipGenJni",
         "-Apackage_prefix=android.net.http.internal",
     ],
+    min_sdk_version: "30",
 }
 
 // GN: //base/android/jni_generator:jni_processor
diff --git a/base/BUILD.gn b/base/BUILD.gn
index c2263d7a..02c76108 100644
--- a/base/BUILD.gn
+++ b/base/BUILD.gn
@@ -4098,6 +4098,7 @@ if (is_android) {
       "android/java/src/org/chromium/base/MemoryPressureListener.java",
       "android/java/src/org/chromium/base/PathService.java",
       "android/java/src/org/chromium/base/PathUtils.java",
+      "android/java/src/org/chromium/base/PiiElider.java",
       "android/java/src/org/chromium/base/PowerMonitor.java",
       "android/java/src/org/chromium/base/RadioUtils.java",
       "android/java/src/org/chromium/base/SysUtils.java",
diff --git a/base/android/java/src/org/chromium/base/PiiElider.java b/base/android/java/src/org/chromium/base/PiiElider.java
index c24e6d17..6c9f8440 100644
--- a/base/android/java/src/org/chromium/base/PiiElider.java
+++ b/base/android/java/src/org/chromium/base/PiiElider.java
@@ -5,9 +5,10 @@
 package org.chromium.base;
 
 import android.text.TextUtils;
+import android.util.Log;
 import android.util.Patterns;
 
-import org.chromium.build.annotations.UsedByReflection;
+import org.chromium.base.annotations.CalledByNative;
 
 import java.util.regex.Matcher;
 import java.util.regex.Pattern;
@@ -217,7 +218,6 @@ public class PiiElider {
      * @param stacktrace Multiline stacktrace as a string.
      * @return Stacktrace with elided URLs.
      */
-    @UsedByReflection("jni_android.cc")
     public static String sanitizeStacktrace(String stacktrace) {
         String[] frames = stacktrace.split("\\n");
         // Sanitize first stacktrace line which contains the exception message.
@@ -230,4 +230,13 @@ public class PiiElider {
         }
         return TextUtils.join("\n", frames);
     }
+
+    /**
+     * Returns a sanitized stacktrace (per {@link #sanitizeStacktrace(String)}) for the given
+     * throwable.
+     */
+    @CalledByNative
+    public static String getSanitizedStacktrace(Throwable throwable) {
+        return sanitizeStacktrace(Log.getStackTraceString(throwable));
+    }
 }
diff --git a/base/android/jni_android.cc b/base/android/jni_android.cc
index f0c58588..b8a0359c 100644
--- a/base/android/jni_android.cc
+++ b/base/android/jni_android.cc
@@ -12,6 +12,7 @@
 #include "base/android/java_exception_reporter.h"
 #include "base/android/jni_string.h"
 #include "base/android/jni_utils.h"
+#include "base/base_jni_headers/PiiElider_jni.h"
 #include "base/containers/flat_map.h"
 #include "base/debug/debugging_buildflags.h"
 #include "base/lazy_instance.h"
@@ -307,28 +308,9 @@ void CheckException(JNIEnv* env) {
 }
 
 std::string GetJavaExceptionInfo(JNIEnv* env, jthrowable java_throwable) {
-  ScopedJavaLocalRef<jclass> log_clazz = GetClass(env, "android/util/Log");
-  jmethodID log_getstacktracestring = MethodID::Get<MethodID::TYPE_STATIC>(
-      env, log_clazz.obj(), "getStackTraceString",
-      "(Ljava/lang/Throwable;)Ljava/lang/String;");
-
-  // Call Log.getStackTraceString()
-  ScopedJavaLocalRef<jstring> exception_string(
-      env, static_cast<jstring>(env->CallStaticObjectMethod(
-               log_clazz.obj(), log_getstacktracestring, java_throwable)));
-  CheckException(env);
-
-  ScopedJavaLocalRef<jclass> piielider_clazz =
-      GetClass(env, "org/chromium/base/PiiElider");
-  jmethodID piielider_sanitize_stacktrace =
-      MethodID::Get<MethodID::TYPE_STATIC>(
-          env, piielider_clazz.obj(), "sanitizeStacktrace",
-          "(Ljava/lang/String;)Ljava/lang/String;");
-  ScopedJavaLocalRef<jstring> sanitized_exception_string(
-      env, static_cast<jstring>(env->CallStaticObjectMethod(
-               piielider_clazz.obj(), piielider_sanitize_stacktrace,
-               exception_string.obj())));
-  CheckException(env);
+  ScopedJavaLocalRef<jstring> sanitized_exception_string =
+      Java_PiiElider_getSanitizedStacktrace(
+          env, ScopedJavaLocalRef(env, java_throwable));
 
   return ConvertJavaStringToUTF8(sanitized_exception_string);
 }
-- 
2.39.0.314.g84b9a713c41-goog

