From 6f9743225efc8b31545beb7c8a2ef57a6d16d3ae Mon Sep 17 00:00:00 2001
From: Stefano Duo <stefanoduo@google.com>
Date: Tue, 7 Mar 2023 12:10:15 +0000
Subject: [PATCH] net: depend on sql only for non-Cronet builds

Cq-Include-Trybots: luci.chromium.try:android-cronet-arm-dbg,ios-m1-simulator-cronet,android_cronet,android-cronet-x86-rel-kitkat-tests,android-cronet-x86-rel,android-cronet-x86-dbg-pie-tests,android-cronet-x86-dbg-oreo-tests,android-cronet-x86-dbg-11-tests,android-cronet-x86-dbg-10-tests,android-cronet-x86-dbg,android-cronet-asan-arm-rel,android-cronet-arm64-rel,android-cronet-arm64-dbg
Change-Id: Ida2181e2a11e32f46a525ef806fcfc988f930df8
---
 net/BUILD.gn | 35 +++++++++++++++++++++++++----------
 1 file changed, 25 insertions(+), 10 deletions(-)

diff --git a/net/BUILD.gn b/net/BUILD.gn
index 2fc1a575d0387..771595bf60607 100644
--- a/net/BUILD.gn
+++ b/net/BUILD.gn
@@ -112,9 +112,9 @@ source_set("constants") {
   deps = [ "//base" ]
 }
 
-buildflag_header("ios_cronet_buildflags") {
-  header = "ios_cronet_buildflags.h"
-  header_dir = "net/socket"
+buildflag_header("cronet_buildflags") {
+  header = "cronet_buildflags.h"
+  header_dir = "net/base"
   flags = [ "CRONET_BUILD=$is_cronet_build" ]
 }
 
@@ -1067,7 +1067,7 @@ component("net") {
   }
 
   deps = [
-    ":ios_cronet_buildflags",
+    ":cronet_buildflags",
     ":net_deps",
     "//build:chromeos_buildflags",
     "//net/data/ssl/chrome_root_store:gen_root_store_inc",
@@ -2206,6 +2206,7 @@ static_library("test_support") {
   configs += [ "//build/config:precompiled_headers" ]
 
   public_deps = [
+    ":cronet_buildflags",
     ":gtest_util",
     "//base",
     "//base/test:test_support",
@@ -4412,7 +4413,6 @@ test("net_unittests") {
     "disk_cache/simple/simple_test_util.h",
     "disk_cache/simple/simple_util_unittest.cc",
     "disk_cache/simple/simple_version_upgrade_unittest.cc",
-    "extras/sqlite/sqlite_persistent_cookie_store_unittest.cc",
     "filter/filter_source_stream_unittest.cc",
     "filter/gzip_source_stream_unittest.cc",
     "first_party_sets/addition_overlaps_union_find_unittest.cc",
@@ -4477,7 +4477,6 @@ test("net_unittests") {
     "log/net_log_unittest.cc",
     "log/net_log_util_unittest.cc",
     "log/net_log_values_unittest.cc",
-    "log/trace_net_log_observer_unittest.cc",
     "nqe/effective_connection_type_unittest.cc",
     "nqe/event_creator_unittest.cc",
     "nqe/network_id_unittest.cc",
@@ -4615,6 +4614,13 @@ test("net_unittests") {
     "url_request/view_cache_helper_unittest.cc",
   ]
 
+  if (!is_cronet_build) {
+    sources += [
+      "extras/sqlite/sqlite_persistent_cookie_store_unittest.cc",
+      "log/trace_net_log_observer_unittest.cc",
+    ]
+  }
+
   if (is_android) {
     sources += [
       "android/dummy_spnego_authenticator.cc",
@@ -4681,7 +4687,6 @@ test("net_unittests") {
   defines = []
 
   deps = [
-    ":extras",
     ":net",
     ":preload_decoder",
     ":quic_test_tools",
@@ -4692,7 +4697,6 @@ test("net_unittests") {
     "//base:i18n",
     "//base/third_party/dynamic_annotations",
     "//build:chromeos_buildflags",
-    "//components/sqlite_proto",
     "//crypto",
     "//crypto:test_support",
     "//net/base/registry_controlled_domains",
@@ -4703,7 +4707,6 @@ test("net_unittests") {
     "//net/http:transport_security_state_unittest_data_default",
     "//net/third_party/quiche:quiche_tests",
     "//net/tools/huffman_trie:huffman_trie_generator_sources",
-    "//sql",
     "//testing/gmock",
     "//testing/gtest",
     "//third_party/protobuf:protobuf_lite",
@@ -4716,6 +4719,14 @@ test("net_unittests") {
     deps += [ "//net/server:tests" ]
   }
 
+  if (!is_cronet_build) {
+    deps += [
+      ":extras",
+      "//components/sqlite_proto",
+      "//sql",
+    ]
+  }
+
   if (is_posix) {
     sources += [ "base/sockaddr_util_posix_unittest.cc" ]
   }
@@ -4726,7 +4737,6 @@ test("net_unittests") {
 
   if (enable_reporting) {
     sources += [
-      "extras/sqlite/sqlite_persistent_reporting_and_nel_store_unittest.cc",
       "network_error_logging/mock_persistent_nel_store_unittest.cc",
       "network_error_logging/network_error_logging_service_unittest.cc",
       "reporting/mock_persistent_reporting_store_unittest.cc",
@@ -4740,6 +4750,11 @@ test("net_unittests") {
       "reporting/reporting_service_unittest.cc",
       "reporting/reporting_uploader_unittest.cc",
     ]
+    if (!is_cronet_build) {
+      sources += [
+        "extras/sqlite/sqlite_persistent_reporting_and_nel_store_unittest.cc",
+      ]
+    }
   }
 
   data = [
-- 
2.40.0.348.gf938b09366-goog

